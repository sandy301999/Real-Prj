---
- name: webserver setup
  hosts: webserver
  become: yes
  gather_facts: yes

  vars:
    src_d: ../docker
    dest_d: /opt/docker/
    packages:
     - vim
     - git
     - curl
     - nginx
     - sshd
    services:
     - sshd
     - nginx
     - docker


  tasks:
    - name: install packages
      package:
        name: "{{ item }}"
        state: present
      loop: "{{ packages }}"
    
    - name: start the service
      service:
        name: "{{ item }}"
        state: started
        enabled: yes
      loop: "{{ services }}"

    - name: copy index file
      ansible.builtin.copy:
        src: "{{ src_d}}"
        dest: "{{ dest_d}}"
        owner: root
        group: root
        mode: '0755'

    - name: archive log files
      archive:
        path: /ibus/fetalink
        dest: /ibus/logs/fetalink_bkup.tar.gz
        format: gz
    
    - name: hardening task
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^PermitRootLogin'
        line: 'PermitRootLogin no'
      notify: restart ssh
      
  handlers: 
      - name: restart ssh
        service:
          name: sshd
          state: restarted
        register: op


- name: rolling updates
  hosts: all
  serial: 1
  tasks:
    - name: restart application
      service:
        name: sshd
        state: restarted

    - name: run custom script
      command: bash /ibus/healthcheck.sh

    - name: Run system updates (apt/yum)
      package:
        name: "*"
        state: latest

    - name: Print OS NAME
      debug:
        var: ansible_distribution
    
    - name: Start and enable NTP service on CentOS
      systemd:
        name: chronyd
        state: started
        enabled: yes
      when: ansible_distribution == "CentOS"

    - name: Create log rotation script
      copy:
        dest: /usr/local/bin/log_cleanup.sh
        mode: '0755'
        content: |
          #!/bin/bash
          LOG_DIR="/var/log/myapp"
          find $LOG_DIR -type f -name "*.log" -mtime +7 -exec gzip {} \;
          find $LOG_DIR -type f -name "*.gz" -mtime +30 -delete

    - name: Schedule cron job for log cleanup
      cron:
        name: "Daily log rotation and cleanup"
        user: root
        job: "/usr/local/bin/log_cleanup.sh > /var/log/log_cleanup.log 2>&1"
        minute: 0
        hour: 2
        state: present

